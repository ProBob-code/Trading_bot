<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Report | GodBotTrade</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Report Specific Styles */
        .report-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            background: var(--bg-card);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .report-title h1 {
            font-size: 24px;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #fff, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .report-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        /* Reusing btn-system-pause styles from styles.css */

        .date-picker {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
        }

        .btn-refresh,
        .btn-export {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-refresh:hover,
        .btn-export:hover {
            border-color: var(--accent);
            background: rgba(124, 58, 237, 0.1);
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), #f59e0b);
        }

        .summary-card.profit::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .summary-card.loss::before {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .summary-card-value {
            font-size: 28px;
            font-weight: 700;
            margin: 12px 0;
        }

        .summary-card-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Drag & Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 24px;
            color: var(--text-secondary);
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.02);
        }

        .drop-zone.dragover {
            border-color: var(--accent);
            background: rgba(124, 58, 237, 0.05);
            color: var(--accent);
        }

        /* Transactions Section */
        .transactions-section {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .transactions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .view-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .toggle-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
        }

        .toggle-btn.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .transactions-table th {
            text-align: left;
            padding: 16px 24px;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }

        .transactions-table td {
            padding: 16px 24px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .transactions-table tr:hover {
            background: var(--bg-secondary);
        }

        .tx-pnl.positive {
            color: #10b981;
        }

        .tx-pnl.negative {
            color: #ef4444;
        }

        .tx-side {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .tx-side.buy {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .tx-side.sell {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .tx-side.close {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }
    </style>
</head>

<body>
    <div class="app" style="display: block;">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">‚ö°</span>
                <span class="logo-text">GodBotTrade</span>
                <span class="logo-tagline">TRADING REPORT</span>
            </div>
            <div class="header-right">
                <a href="/" class="btn-refresh">‚Üê Back to Dashboard</a>
            </div>
        </header>

        <!-- Report Content -->
        <div class="report-container">
            <!-- Report Header -->
            <div class="report-header">
                <div class="report-title">
                    <h1>üìä Performance Report</h1>
                    <div class="report-subtitle">
                        <span id="reportStatus">Real-time trade analysis</span>
                    </div>
                </div>
                <div class="report-controls">
                    <!-- Global System Pause -->
                    <button id="btnSystemPause" class="btn-system-pause" onclick="toggleSystemPause()"
                        title="Pause/Resume All Trading">
                        <span class="pause-icon">‚è∏Ô∏è</span>
                        <span class="pause-text">Running</span>
                    </button>
                    <input type="date" id="reportDate" class="date-picker">
                    <button class="btn-refresh" onclick="loadData()">üîÑ Refresh</button>
                    <button class="btn-export" onclick="exportCSV()">üì• Export CSV</button>
                </div>
            </div>

            <!-- Drag & Drop Zone -->
            <div id="dropZone" class="drop-zone">
                üìÇ Drag & drop a report JSON file here to load external analysis
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="summary-card profit">
                    <div class="summary-card-label">Total P&L</div>
                    <div class="summary-card-value" id="totalPnl">$0.00</div>
                    <div class="summary-card-change" id="winRate">0% Win Rate</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total Trades</div>
                    <div class="summary-card-value" id="totalTrades">0</div>
                    <div class="summary-card-change" id="tradeVolume">$0 Vol</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Best Trade</div>
                    <div class="summary-card-value" id="bestTrade">$0.00</div>
                    <div class="summary-card-change positive">Top Win</div>
                </div>
                <div class="summary-card loss">
                    <div class="summary-card-label">Worst Trade</div>
                    <div class="summary-card-value" id="worstTrade">$0.00</div>
                    <div class="summary-card-change negative">Max Drawdown</div>
                </div>
            </div>

            <!-- Transactions Table -->
            <div class="transactions-section">
                <div class="transactions-header">
                    <div class="view-toggle">
                        <button class="toggle-btn active" onclick="setView('flat')" id="btnFlat">Flat View</button>
                        <button class="toggle-btn" onclick="setView('roundtrip')" id="btnRound">Round Trip</button>
                    </div>
                    <span style="font-size: 12px; color: var(--text-secondary);" id="txCount">0 records</span>
                </div>
                <table class="transactions-table">
                    <thead id="tableHead">
                        <!-- Dynamic Header -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let currentView = 'flat'; // 'flat' or 'roundtrip'

        document.addEventListener('DOMContentLoaded', () => {
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;

            // Listen for date change
            document.getElementById('reportDate').addEventListener('change', loadData);

            // Drag & Drop
            const dropZone = document.getElementById('dropZone');

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) loadFromFile(file);
            });

            // Initial Load
            loadData();
        });

        async function loadData() {
            const date = document.getElementById('reportDate').value;
            try {
                // Fetch Trades from API
                const res = await fetch(`/api/reports/trades?date=${date}&limit=1000`);
                const data = await res.json();

                currentData = data;
                updateUI();

                // Also fetch summary for accurate top-level stats
                const summaryRes = await fetch(`/api/reports/summary?date=${date}`);
                const summary = await summaryRes.json();
                updateSummary(summary, data);

                document.getElementById('reportStatus').textContent = `Showing data for ${date}`;

            } catch (e) {
                console.error("Error loading data:", e);
                //alert("Failed to load report data");
            }
        }

        function loadFromFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    // Handle different export formats (array vs object)
                    if (Array.isArray(json)) currentData = json;
                    else if (json.trades_log) currentData = json.trades_log;
                    else if (json.trades) currentData = json.trades;

                    updateUI();
                    calculateSummaryFromData(currentData);
                    document.getElementById('reportStatus').textContent = `Loaded file: ${file.name}`;
                } catch (err) {
                    alert("Invalid JSON file");
                }
            };
            reader.readAsText(file);
        }

        function setView(view) {
            currentView = view;
            document.getElementById('btnFlat').classList.toggle('active', view === 'flat');
            document.getElementById('btnRound').classList.toggle('active', view === 'roundtrip');
            updateUI();
        }

        function updateUI() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (currentView === 'flat') {
                renderFlatView(thead, tbody);
            } else {
                renderRoundTripView(thead, tbody);
            }

            document.getElementById('txCount').textContent = `${currentData.length} records`;
        }

        function renderFlatView(thead, tbody) {
            thead.innerHTML = `
                <tr>
                    <th>Time</th>
                    <th>Symbol</th>
                    <th>Side</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Value</th>
                    <th>P&L</th>
                    <th>Bot / Strategy</th>
                </tr>
            `;

            if (currentData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 40px; color: var(--text-secondary);">No trades found for this period</td></tr>`;
                return;
            }

            currentData.forEach(d => {
                const pnl = d.pnl || 0;
                const value = d.value || (d.quantity * d.price) || 0;
                const time = new Date(d.timestamp).toLocaleTimeString();

                const row = `
                    <tr>
                        <td>${time}</td>
                        <td style="font-weight:600">${d.symbol}</td>
                        <td><span class="tx-side ${d.side === 'CLOSE' ? 'close' : d.side.toLowerCase()}">${d.side}</span></td>
                        <td>${formatCurrency(d.price)}</td>
                        <td>${d.quantity}</td>
                        <td>${formatCurrency(value)}</td>
                        <td class="tx-pnl ${pnl >= 0 ? 'positive' : 'negative'}">
                            ${pnl !== 0 ? (pnl > 0 ? '+' : '') + formatCurrency(pnl) : '-'}
                        </td>
                        <td style="font-size:12px; color:var(--text-secondary);">${d.bot_id} (${d.strategy})</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderRoundTripView(thead, tbody) {
            thead.innerHTML = `
                <tr>
                    <th>Close Time</th>
                    <th>Symbol</th>
                    <th>Qty</th>
                    <th>Entry Price</th>
                    <th>Exit Price</th>
                    <th>Realized P&L</th>
                    <th>Duration</th>
                </tr>
            `;

            // Filter only trades with realized P&L != 0 or explicit EXIT
            const closedTrades = currentData.filter(d => d.pnl !== 0 || d.trade_type === 'EXIT');

            if (closedTrades.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color: var(--text-secondary);">No closed positions found</td></tr>`;
                return;
            }

            closedTrades.forEach(d => {
                const time = new Date(d.timestamp).toLocaleTimeString();
                // Estimate entry price (simplified without full linking)
                // If we had full linking, we'd lookup the entry trade here

                const row = `
                    <tr>
                        <td>${time}</td>
                        <td style="font-weight:600">${d.symbol}</td>
                        <td>${d.quantity}</td>
                        <td>-</td> <!-- Needs round-trip entry lookup -->
                        <td>${formatCurrency(d.price)}</td>
                        <td class="tx-pnl ${d.pnl >= 0 ? 'positive' : 'negative'}">
                            ${(d.pnl > 0 ? '+' : '') + formatCurrency(d.pnl)}
                        </td>
                        <td>-</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function updateSummary(summary, trades) {
            // If summary API fails, calc from trades
            if (!summary || !summary.total_trades) {
                calculateSummaryFromData(trades);
                return;
            }

            document.getElementById('totalPnl').textContent = formatCurrency(summary.total_pnl);
            document.getElementById('totalPnl').className = 'summary-card-value ' + (summary.total_pnl >= 0 ? 'positive' : 'negative');
            document.getElementById('totalTrades').textContent = summary.total_trades;
            document.getElementById('tradeVolume').textContent = formatCurrency(summary.total_volume) + " Vol";

            // Calc best/worst from trades list
            let best = 0, worst = 0;
            trades.forEach(t => {
                if (t.pnl) {
                    if (t.pnl > best) best = t.pnl;
                    if (t.pnl < worst) worst = t.pnl;
                }
            });
            document.getElementById('bestTrade').textContent = formatCurrency(best);
            document.getElementById('worstTrade').textContent = formatCurrency(worst);

            const winRate = summary.total_trades > 0 ? (summary.wins / summary.total_trades * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = `${winRate}% Win Rate`;
        }

        function calculateSummaryFromData(trades) {
            let pnl = 0, vol = 0, wins = 0, count = 0;
            let best = 0, worst = 0;

            trades.forEach(t => {
                count++;
                pnl += (t.pnl || 0);
                vol += (t.value || 0);
                if ((t.pnl || 0) > 0) wins++;
                if ((t.pnl || 0) > best) best = t.pnl;
                if ((t.pnl || 0) < worst) worst = t.pnl;
            });

            document.getElementById('totalPnl').textContent = formatCurrency(pnl);
            document.getElementById('totalPnl').className = 'summary-card-value ' + (pnl >= 0 ? 'positive' : 'negative');
            document.getElementById('totalTrades').textContent = count;
            document.getElementById('tradeVolume').textContent = formatCurrency(vol) + " Vol";
            document.getElementById('bestTrade').textContent = formatCurrency(best);
            document.getElementById('worstTrade').textContent = formatCurrency(worst);

            const winRate = count > 0 ? (wins / count * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = `${winRate}% Win Rate`;
        }

        function formatCurrency(val) {
            return '$' + parseFloat(val || 0).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function exportCSV() {
            if (currentData.length === 0) {
                alert("No data to export");
                return;
            }

            const headers = Object.keys(currentData[0]);
            const csvRows = [];
            csvRows.push(headers.join(','));

            currentData.forEach(row => {
                const values = headers.map(header => {
                    const val = row[header] || '';
                    return `"${val}"`;
                });
                csvRows.push(values.join(','));
            });

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trading_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ============================================
        // SYSTEM PAUSE LOGIC
        // ============================================
        let isSystemPaused = false;

        async function checkSystemStatus() {
            try {
                const res = await fetch('/api/system/status');
                const data = await res.json();
                updateSystemStatusUI(data.paused);
            } catch (e) {
                console.error('Failed to fetch system status:', e);
            }
        }

        async function toggleSystemPause() {
            const endpoint = isSystemPaused ? '/api/system/resume' : '/api/system/pause';
            try {
                const res = await fetch(endpoint, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    updateSystemStatusUI(data.paused);
                }
            } catch (e) {
                alert('Failed to toggle system status');
            }
        }

        function updateSystemStatusUI(paused) {
            isSystemPaused = paused;
            const btn = document.getElementById('btnSystemPause');
            const icon = btn.querySelector('.pause-icon');
            const text = btn.querySelector('.pause-text');

            if (paused) {
                btn.classList.add('paused');
                icon.textContent = '‚ñ∂Ô∏è';
                text.textContent = 'Paused';
                btn.title = "System is PAUSED. Click to Resume.";
            } else {
                btn.classList.remove('paused');
                icon.textContent = '‚è∏Ô∏è';
                text.textContent = 'Running';
                btn.title = "System is RUNNING. Click to Pause.";
            }
        }

        // Check on load
        checkSystemStatus();
        setInterval(checkSystemStatus, 10000);
    </script>
</body>

</html>